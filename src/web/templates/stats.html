{% extends "base.html" %}

{% block title %}Statistics — {{ code }} - URL Shortener{% endblock %}

{% block extra_styles %}
<script src="/static/js/echarts.min.js"></script>
{% endblock %}

{% block content %}
<div x-data="statsPage('{{ code }}')" x-init="init()" x-cloak>

    <!-- Breadcrumb -->
    <nav class="text-sm text-gray-500 mb-4">
        <a href="/dashboard" class="hover:text-blue-600 transition-colors">Home</a>
        <span class="mx-1.5 text-gray-300">/</span>
        <a href="/dashboard/links" class="hover:text-blue-600 transition-colors">Links</a>
        <span class="mx-1.5 text-gray-300">/</span>
        <span class="font-mono" x-text="code"></span>
    </nav>

    <!-- Link Info -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 mb-4">
        <div class="flex items-start justify-between mb-4">
            <h2 class="text-base font-semibold text-gray-900">Link Information</h2>
            <a href="/dashboard/links"
               class="text-sm text-gray-500 hover:text-blue-600 transition-colors">← Back to Links</a>
        </div>

        <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-3 text-sm">
            <div>
                <dt class="text-xs text-gray-500 mb-0.5">Short Link</dt>
                <dd class="flex items-center gap-2">
                    <a :href="shortUrl()"
                       target="_blank"
                       class="font-mono text-blue-600 hover:underline"
                       x-text="shortUrl()"></a>
                    <button @click="navigator.clipboard.writeText(shortUrl())"
                            class="text-xs text-gray-400 hover:text-gray-600 transition-colors">
                        copy
                    </button>
                </dd>
            </div>
            <div>
                <dt class="text-xs text-gray-500 mb-0.5">Original URL</dt>
                <dd>
                    <a :href="info.longUrl"
                       target="_blank"
                       class="text-gray-700 hover:text-blue-600 break-all transition-colors"
                       x-text="info.longUrl || '—'"></a>
                </dd>
            </div>
            <div>
                <dt class="text-xs text-gray-500 mb-0.5">Domain</dt>
                <dd class="font-mono text-gray-700" x-text="info.domain || '—'"></dd>
            </div>
            <div>
                <dt class="text-xs text-gray-500 mb-0.5">Total Clicks</dt>
                <dd class="font-semibold text-gray-900" x-text="info.total ?? '—'"></dd>
            </div>
            <div>
                <dt class="text-xs text-gray-500 mb-0.5">Created</dt>
                <dd class="text-gray-600" x-text="formatDate(info.createdAt)"></dd>
            </div>
        </dl>
    </div>

    <!-- Period Filters -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 mb-4">
        <h2 class="text-base font-semibold text-gray-900 mb-3">Statistics Period</h2>
        <div class="flex flex-wrap gap-2">
            <template x-for="(label, p) in { all: 'All Time', today: 'Today', week: 'This Week', month: 'This Month', custom: 'Custom' }" :key="p">
                <button @click="setQuickFilter(p)"
                        :class="period === p
                            ? 'bg-blue-600 text-white border-blue-600'
                            : 'bg-white text-gray-700 border-gray-200 hover:border-blue-400 hover:text-blue-600'"
                        class="px-4 py-1.5 text-sm border rounded-full transition">
                    <span x-text="label"></span>
                </button>
            </template>
        </div>

        <div x-show="showCustom"
             x-transition:enter="transition ease-out duration-150"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             class="mt-4 flex flex-wrap items-end gap-3">
            <div>
                <label class="block text-xs text-gray-500 mb-1">From</label>
                <input type="datetime-local"
                       x-model="fromDate"
                       class="px-3 py-1.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            </div>
            <div>
                <label class="block text-xs text-gray-500 mb-1">To</label>
                <input type="datetime-local"
                       x-model="toDate"
                       class="px-3 py-1.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            </div>
            <button @click="applyCustom()"
                    class="px-4 py-1.5 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition">
                Apply
            </button>
        </div>
    </div>

    <!-- Chart -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 mb-4">
        <h2 class="text-base font-semibold text-gray-900 mb-4">Clicks Over Time</h2>
        <div id="clicksChart" class="h-64 w-full"></div>
    </div>

    <!-- Click History -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
            <h2 class="text-base font-semibold text-gray-900">Detailed Click History</h2>
        </div>

        <div x-show="loading" class="px-6 py-10 text-center text-sm text-gray-400">Loading…</div>
        <div x-show="!loading && clicks.length === 0"
             x-cloak
             class="px-6 py-10 text-center text-sm text-gray-400">
            No clicks in this period
        </div>

        <div x-show="!loading && clicks.length > 0" x-cloak class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="text-left text-xs text-gray-500 border-b border-gray-100">
                        <th class="px-6 py-3 font-medium">Time</th>
                        <th class="px-6 py-3 font-medium">IP</th>
                        <th class="px-6 py-3 font-medium">Referer</th>
                        <th class="px-6 py-3 font-medium">User Agent</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-50">
                    <template x-for="(click, i) in clicks" :key="i">
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-3 text-gray-600 whitespace-nowrap text-xs"
                                x-text="formatDateTime(click.clickedAt)"></td>
                            <td class="px-6 py-3 text-gray-500 font-mono text-xs"
                                x-text="click.ip || '—'"></td>
                            <td class="px-6 py-3 max-w-xs">
                                <span class="text-gray-500 text-xs truncate block"
                                      x-text="click.referer || '—'"
                                      :title="click.referer"></span>
                            </td>
                            <td class="px-6 py-3 max-w-xs">
                                <span class="text-gray-500 text-xs truncate block"
                                      x-text="click.userAgent || '—'"
                                      :title="click.userAgent"></span>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div x-show="totalPages > 1"
             x-cloak
             class="flex items-center justify-center gap-1 px-4 py-3 border-t border-gray-100">
            <button @click="goToPage(page - 1)"
                    :disabled="page === 1"
                    class="px-3 py-1 text-sm border border-gray-200 rounded hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed transition">
                ←
            </button>
            <template x-for="p in pages" :key="p">
                <button @click="goToPage(p)"
                        :class="p === page
                            ? 'bg-blue-600 text-white border-blue-600'
                            : 'border-gray-200 hover:bg-gray-50'"
                        class="px-3 py-1 text-sm border rounded transition">
                    <span x-text="p"></span>
                </button>
            </template>
            <button @click="goToPage(page + 1)"
                    :disabled="page === totalPages"
                    class="px-3 py-1 text-sm border border-gray-200 rounded hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed transition">
                →
            </button>
        </div>
    </div>

</div>
{% endblock %}
